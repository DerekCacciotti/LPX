<!DOCTYPE html>
<html lang="en">
<head>
    <title>Search</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="bower_components/toastr/toastr.css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="http://www.parsecdn.com/js/parse-1.6.14.min.js"></script>
    <script src="bower_components/multiselect/js/jquery.multi-select.js" type="text/javascript"></script>
    <script src="bower_components/toastr/toastr.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/3.16.0/algoliasearch.min.js"></script>


</head>
<body>

  <nav class=" navbar navbar-default">
    <div class="container-fluid">
      <!-- logo -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collaspe" data-target="#mainnavbar">
          <!-- make the three line icon found on chrome in the menu bar for settings-->
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="index.html" class="navbar-brand">LPX</a>
      </div>

      <!-- MENU ITEMS-->
      <div class="collaspe navbar-collaspe" id="mainnavbar">
        <ul class="nav navbar-nav">
          <li><a href="dashboard.html">Home</a></li>
          <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>


        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
                   <a href="#" class="dropdown-toggle" data-toggle="dropdown">My Profile <span class="caret"></span></a>
                   <ul class="dropdown-menu">
                       <li><a href="dashboard.html">Dashboard</a></li>
                       <li class="active"><a href="search.html">Database</a></li>
                       <li><a href="#">Log Out</a></li>
                   </ul>
               </li>
           </ul>

            </ul>
      </div>
    </div>

  </nav>


<div align="center">


  <br />

  <div class="container">
  	<div class="row">
  		<h2>Search for items</h2>

             <div id="custom-search-input">
                              <div class="input-group col-md-12">
                                  <input type="text" class="search-query form-control" placeholder="Search" id="searchbox" />
                                  <span class="input-group-btn">
                                    <input type="button" class="btn btn-success" value="Search"  name="searchbutton"   onclick="findFood()">


                                      </button>
                                  </span>
                              </div>
                          </div>

  	</div>
  </div>

<div id="selected">
  <p></p>
</div>

<div id="table">
  <table id="results-table" class="table">

<tr>
  <th>Item</th>
  <th>Brand</th>
  <th>Pack</th>
  <th>Size</th>




</tr>



</table>

<div id="bottomarea">

  <input type="button" class="btn btn-link" value="Next"  id="nextresult"   onclick="NextPage()">

</div>



<div class="navbar-fixed-bottom">
  <div class="container">



  </div>
</div>

<script type="text/javascript">


    Parse.initialize("bmobCoB17mgSf7S9J6ZntiQGq5NEm2eIyHroyP9t", "Wut80Nd7rKFVvHEvT7K9jQMCV2HIO67OEH0pWaBe");
      Parse.serverURL = 'https://rayfoodapp.herokuapp.com/parse'

      // Paginatation
      var page = 0

      var resultlimit = 50

// this array will hold the id og the items ordered
var itemsarray =[];

var currentuser = Parse.User.current();

      window.onload = getalldata()

      // this function gets all data is called on load
      function getalldata()
      {
        CheckforFurfilledOrders();
        checkCookie()
        var GameScore = Parse.Object.extend("FoodSourceParse");
      var query = new Parse.Query(GameScore);
      query.limit(resultlimit)
      query.skip(page * resultlimit)
      query.find({
          success: function(results) {
            console.log(results.length)
             for (var i = 0; i < results.length; i++) {
                 var object = results[i];
                     (function($) {

                         $('#results-table').append('<tr><td>' +  object.get('ITEM')  + '</td><td>' + object.get('BRAND') + '</td><td>' + object.get("PACK") + '</td><td>'  + object.get("SIZE") + '</td><td>');

                     })(jQuery);


             }
             // click event
             $("tr").click(function(){
               //alert("click")
               var index = $(this).index();
               //alert(index)
               var dataarray = $(this).children("td").map(function(){
                 return $(this).text();
               }).get();
               console.log(dataarray)

               //alert($.trim(dataarray[0]));
               itemsarray.push($.trim(dataarray[0]));
               console.log(itemsarray);
               LoadProduct();
             })
          },
          error: function(error) {
              alert("Error: " + error.code + " " + error.message);
          }
      });
      }

      function NextPage()
      {
        page++
        getalldata()
        //cleartable();
        // make if the user is a page larger than 1
        if(page != 1)
        {
          var buttondiv = document.getElementById("bottomarea")
          var lastpageButton = document.createElement("input")
          lastpageButton.className = "btn btn-link"
          lastpageButton.type = "button"
          lastpageButton.id = "lastpage"
          lastpageButton.value = "Previous"
          buttondiv.appendChild(lastpageButton)
        }
       if(page == 1)
        {
            $("#lastapage").remove();
        }
        $("#lastpage").click(function() {
          console.log("previous was tapped" + page)
          page--
          getalldata();
        })


        console.log("you are now viewing page " + page)
      }



      function checkCookie() {
    console.log("the current cookie is " + document.cookie)

    if (currentuser == null)
    {
      currentuser = document.cookie
      console.log(currentuser)
    }
    else {
      console.log("user passed")
      console.log(currentuser)
    }


 }


 function CheckforFurfilledOrders()
 {
   var order = Parse.Object.extend("furfilledorders")
   var query = new Parse.Query(order)
   query.equalTo("orderfor", currentuser.get("username"))
   query.find({
  success: function(results) {
  toastr.success("Some sellers got back to you", results.length + " new orders ")


  },
  error: function(error) {
    alert("Error: " + error.code + " " + error.message);
  }
});


 }

function findFood()
{

cleartable()
  var client = algoliasearch("1ZC34ODN95", '5ff9467977022bc22144e1f98657ecf3');
    var index = client.initIndex('Foodsource');

    index.search(document.getElementById("searchbox").value, function searchDone(err, content) {
      console.log(content.hits)
      for(var i = 0; i < content.hits.length; i++)
      {
        console.log(content.hits[i].ITEM)

        var database = Parse.Object.extend("FoodSourceParse");
var query = new Parse.Query(database);
query.equalTo("ITEM", content.hits[i].ITEM);
query.find({
  success: function(results) {
    console.log("Successfully retrieved " + results.length);
    // Do something with the returned Parse.Object values
    for (var i = 0; i < results.length; i++) {
      var object = results[i];

         $('#results-table').append('<tr><td>' +  object.get('ITEM')  + '</td><td>' + object.get('BRAND') + '</td><td>' + object.get("PACK") + '</td><td>'  + object.get("SIZE"));

    }

    $("tr").click(function(){
      //alert("click")
      var index = $(this).index();
      //alert(index)
      var dataarray = $(this).children("td").map(function(){
        return $(this).text();
      }).get();

      //alert($.trim(dataarray[0]));
      itemsarray.push($.trim(dataarray[0]));
      console.log(dataarray[1]);
      LoadProduct();
      console.log(brandarray)
    });
  },
  error: function(error) {
    alert("Error: " + error.code + " " + error.message);
  }
});

      }
    });








/*  cleartable();
  var searchtextupper = document.getElementById("searchbox").value
  var GameScore = Parse.Object.extend("FoodSourceParse");
var query = new Parse.Query(GameScore);
query.equalTo("search", searchtextupper );
query.find({
    success: function(results) {
      console.log(results.length)
       for (var i = 0; i < results.length; i++) {
           var object = results[i];
               (function($) {


           $('#results-table').append('<tr><td>' +  object.get('ITEM')  + '</td><td>' + object.get('BRAND') + '</td><td>' + object.get("PACK") + '</td><td>'  + object.get("SIZE"));

               })(jQuery);


       }

       $("tr").click(function(){
         alert("click")
         var index = $(this).index();
         //alert(index)
         var dataarray = $(this).children("td").map(function(){
           return $(this).text();
         }).get();

         //alert($.trim(dataarray[0]));
         itemsarray.push($.trim(dataarray[0]));
         console.log(itemsarray);
         LoadProduct();

       })
    },
    error: function(error) {
        alert("Error: " + error.code + " " + error.message);
    }
});
*/
}




function cleartable()
{
  var table = document.getElementById("results-table");
  while (table.rows.length > 0) {
    table.deleteRow(0);
    //getalldata();


  }

  table.innerHTML = "<tr>" + " <th>Item</th>" + "<th>Brand</th>" + "<th>Pack</th>" + "<th>Size</th>" + "</tr>"






}

function LoadProduct()
{
  // saving current array
  window.localStorage.setItem("item", JSON.stringify(itemsarray));


  window.location.href = "productpage.html"
}




</script>

</body>
</html>
