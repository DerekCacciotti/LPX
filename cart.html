<!DOCTYPE html>
<html lang="en">
<head>
    <title>Cart</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="http://www.parsecdn.com/js/parse-1.6.14.min.js"></script>
    <script type="text/javascript" src="mandrill.js"></script>
  <script src="node_modules/node-uuid/uuid.js"></script>
</head>
<body>

  <nav class=" navbar navbar-default">
    <div class="container-fluid">
      <!-- logo -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collaspe" data-target="#mainnavbar">
          <!-- make the three line icon found on chrome in the menu bar for settings-->
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="index.html" class="navbar-brand">LPX</a>
      </div>

      <!-- MENU ITEMS-->
      <div class="collaspe navbar-collaspe" id="mainnavbar">
        <ul class="nav navbar-nav">
          <li class="active"><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>


<!-- right align menu item for login and sign uo buttons-->
<ul class="nav navbar-nav navbar-right">
  <li class="dropdown">
           <a href="#" class="dropdown-toggle" data-toggle="dropdown">My Profile <span class="caret"></span></a>
           <ul class="dropdown-menu">
               <li><a href="dashboard/dashboard.html">Dashboard</a></li>
               <li><a href="search.html">Database</a></li>
               <li><a href="#">Log Out</a></li>
           </ul>
       </li>
   </ul>


      </div>
    </div>

  </nav>

  <div class="dropdown" id="dropdownbutton">
  <button class="btn btn-link dropdown-toggle pull-right" type="button" data-toggle="dropdown">Recent Orders
  <span class="caret"></span></button>
  <ul class="dropdown-menu pull-right" id="dropdownmenu">

  </ul>
</div>

<div class="container">
  <h4>Current order <span><h1 id="cartnote">to ensure the highest procurement possable, If you make a mistake, Please cancel your order and start again.</h1></span></h4>
  <br />
  <div id="table">

    <table id="order-table" class="table">

  <tr>
    <th>Item</th>
    <th>Amount</th>
    <th>Size</th>
    <th>Pack</th>









  </tr>





  </table>
  </div>





    <input type="button" class="btn btn-primary pull-right" onclick="ShowSalesRepInfo()" value="Prepare Order">
    <input type="button" class="btn btn-warning " value="Back to Search"  name="backtosearch"   onclick="BacktoSearch()">
      <input type="button" class="btn btn-danger " value="Cancel Order"  name="cancelorder"   onclick="CancelOrder()">



</div>
<br />

<div id="formarea">
  <form>
    <fieldset>
      <legend>Sales rep info<span><input type="button" class="btn btn-danger  btn-sm pull-right" value="Close"  name="submitorder" id="close"   onclick="CloseSellerPane()"></span></legend>
      <input type="text" class="form-control" placeholder="Please enter the email address of the seller you would like to send the order to"  id="addemail"/>
      <br />
      <h4 class="center">Please select and confrim suppliers</h4>



      <br />


    <select multiple="multiple" class="form-control" id="select">

</select>

<br />

<input type="button" class="btn btn-success  btn-sm " value="Submit Order"  name="submitorder" id="submitbutton"   onclick="CreateOrder()">




    </fieldset>
  </form>




</div>






<script type="text/javascript">

$("#formarea").toggle();

Parse.initialize("bmobCoB17mgSf7S9J6ZntiQGq5NEm2eIyHroyP9t", "Wut80Nd7rKFVvHEvT7K9jQMCV2HIO67OEH0pWaBe");
  Parse.serverURL = 'https://rayfoodapp.herokuapp.com/parse'

   poplatedropdown();

  var sessiontoken = Parse.Session.sessionToken;
  console.log(sessiontoken)


var orderarray = JSON.parse(window.localStorage.getItem("currentcart"))

var itemid;
var amount
var finalamounts;

var itemidsarray = [];
var amountarray = [];
var finalorder = [];
var isfurfilled = false;
var userdata = []




  var currentuser = Parse.User.current();
console.log(orderarray);
console.log(currentuser)

for(var i = 0; i < orderarray.length; i++)
{
  itemidsarray.push(orderarray[i].itemid)
  amountarray.push(orderarray[i].amount)
}
console.log(itemidsarray)
console.log(amountarray)

//console.log(itemid)

// loop through itemids to populate the table

for (var j = 0; j <= itemidsarray.length; ++j)
{

    var database = Parse.Object.extend("FoodSourceParse")
     var query = new Parse.Query(database)
     query.get(itemidsarray[j],  {
      success: function(object)

      {
        console.log(object.get('ITEM'));
        console.log(object.get("SIZE"));



         $('#order-table').append('<tr><td id="item">' +   object.get('ITEM')  + '</td><td>' + 	'<input type="number" id="quanity" class="form-control text-center" value=1> ' + "</td><td>" + object.get("SIZE") + "</td><td>" + object.get("PACK") +  '</td></tr>');






      }


    })
}








function cleartable()
{
  var table = document.getElementById("order-table");
  while (table.rows.length > 0) {
    table.deleteRow(2);



  }









}


function BacktoSearch()
  {
    var table = $('#order-table')
    table.find('tr').each(function (i) {
            var $input = $(this).find("#quanity");
            var enteredamount = $input.eq(0).val();
            console.log(enteredamount)
            userdata.push(enteredamount);



    });

    localStorage.setItem('userdata', userdata);
    useramountssaved = true;


    window.location.href = "search.html"




  }

  function checkforuserdata()
  {
    if  (localStorage.getItem("userdata") === null)
    {
      return;
    }
    else
    {
      var data = localStorage.getItem("userdata")
      console.log(data)

      for(var i = 0; i < data.length; i++)
      {
        userdata.push(data[i])
      }

      var search_term = ",";

      for (var i=userdata.length-1; i>=0; i--) {
          if (userdata[i] === search_term) {
              userdata.splice(i, 1);

          }
      }
      console.log(userdata)
      var table = $('#order-table')

      for(var i = 0; i < userdata.length; i++)
      {
        table.find('tr').each(function (i) {
              document.getElementById("quanity").value = userdata[i]





        });

      }

    }
  }

  function ShowSalesRepInfo()
  {
    $("#formarea").toggle();

    //console.log(currentuser.id)
    // get sellers

    var index = 0;
    var Loggedin = Parse.User.current();
    var users = Parse.Object.extend("_User")
    var query = new Parse.Query(users);
    if (currentuser == null)
    {
      currentuser = document.cookie
    }
query.get(currentuser.id, {
  success: function(results) {
    console.log(results)

    var sellers = results.get("salesreps")
    console.log(sellers)


    var selecttag = document.getElementById("select")

     for(seller in sellers)
     {
       var option = document.createElement("option")
       option.value = index
       option.innerHTML = sellers[seller]


      selecttag.appendChild(option)
      index++




     }




  },
  error: function(object, error) {
    // The object was not retrieved successfully.
    // error is a Parse.Error with an error code and message.
  }
});



  }


  function CloseSellerPane()
  {
    $("#formarea").toggle();
  }

  function CreateOrder()
  {
    var sellersarray = []
    var table = $('#order-table')

    table.find('tr').each(function (i) {
        var $tds = $(this).find('td'),
            product = $tds.eq(0).text(),
            Quantity = $tds.eq(1).text(),
            size = $tds.eq(2).text(),
            pack = $tds.eq(3).text();
            var $input = $(this).find("#quanity"),
            amount2 = $input.eq(0).val()



            //console.log(product)
          //  console.log(Quantity)
            console.log(amount2)
            console.log(pack)

            var Order = {};
            Order.item = product
            Order.amount = amount2
            Order.sizeamount = size
            Order.pack = pack

          finalorder.push(Order)
          //finalorder.push(Quantity)
          //inalorder.push(amount2)

    });

    console.log(finalorder)



    for(var d = 0; d < finalorder.length; d++)
    {
      console.log(finalorder[d])



      //console.log(ordernum)






}

console.log(finalorder)







  var order = Parse.Object.extend("Order");
  var orderobj = new order();
  console.log(currentuser);
  var select = document.getElementById("select")
    for (var i = 0; i < select.options.length; i++) {
       if(select.options[i].selected ==true){
            console.log(select.options[i].innerHTML);
            sellersarray.push(select.options[i].innerHTML)
        }
    }

    var addemailvalue = document.getElementById("addemail").value

    if (addemailvalue.length != 0)
    {
      console.log("text has changed")
      console.log(addemailvalue)
      sellersarray.push(addemailvalue)
      console.log(sellersarray)
    }





 orderobj.set("order", finalorder)
  orderobj.set("submitedbyusername", currentuser.get("username"))
  orderobj.set("selectedsellers", sellersarray)
  orderobj.set("isfurfilled", isfurfilled)
  orderobj.set("returnemail", currentuser.get("email"))
  orderobj.save(null, {
  success: function(submiitedorder) {
    // create unique link


    alert('Your order has been submitted ' + submiitedorder.id);
    SendEmail(sellersarray, submiitedorder);
    localStorage.removeItem("currentcart")
    localStorage.removeItem("userdata")



  },
  error: function(submiitedorder, error) {
    // Execute any logic that should take place if the save fails.
    // error is a Parse.Error with an error code and message.
    alert('Failed to create new object, with error code: ' + error.message);
  }
});










}

function CancelOrder()
{
  orderarray = [];
  localStorage.removeItem("currentcart");
  BacktoSearch();
  itemidsarray = []
  localStorage.removeItem("userdata")
  userdata = []


}

function SendEmail(array, pobject)
{
  console.log("the sellers are " + array)

  // loop through sellers arrays
  for (object in array)
  {
    var email = new mandrill.Mandrill('TMc9w9HepAG7nUI1amdO3g'); // This will be public



    var params = {
  "template_name": "LPXCart",
  "template_content": [
      {
          "name": "test",
          "content": "testing"
      }
  ],

  "message": {
      "from_email":"orders@lpxco.com",
      "to":[{"email":array[object], "name": "Confidental"}],
      "subject": "LPX order " + pobject.id + " needs to be furfilled " ,
      "text": "Hello, your LPX order number " + pobject.id +  " has been furfilled " + " please check out the dashboard to see pricing"
  }
  };

  email.messages.sendTemplate(params, function(res) {
      log(res);
  }, function(err) {
      log(err);
  });
  }


}






// poplates drop down
function poplatedropdown()
{

  var loggedinuser = Parse.User.current();
    console.log(loggedinuser)
  var order = Parse.Object.extend("Order");
var query = new Parse.Query(order);
query.equalTo("submitedbyusername", loggedinuser.get("username"));
query.find({
  success: function(results) {
    console.log("Successfully retrieved " + results.length);
    // Do something with the returned Parse.Object values
    for(var i = 0; i < results.length; i++ )
    {
      var dropdownmenu = document.getElementById("dropdownmenu")
    var li =  document.createElement("li")
    //li.innerHTML = results[i].id
    var atag = document.createElement("a")
    //dropdownmenu.appendChild(li)
    atag.href = "#"
    atag.innerHTML = results[i].id
    li.appendChild(atag)
    dropdownmenu.appendChild(li)


    }

    $("#dropdownmenu a").click(function() {
      var ordernumber = this.innerHTML;
    //lert(this.innerHTML)
    //cleartable();

    var Order = Parse.Object.extend("Order");
var query = new Parse.Query(Order);
query.get(ordernumber, {
  success: function(savedorder) {
    var order = savedorder.get("order");

    var search_term = '';

    for (var i=order.length-1; i>=0; i--) {
        if (order[i].item === search_term) {
            order.splice(i, 1);
             break;
        }
    }

    for (var i  = 0; i < order.length; i++)
    {
      console.log(order[i].sizeamount)
      $('#order-table').append('<tr><td id="item">' +   order[i].item  + '</td><td>' + 	'<input type="number" id="quanity" class="form-control text-center" value=1> ' + "</td><td>" + order[i].sizeamount + "</td><td>" + order[i].pack +  '</td></tr>');


    }

  },
  error: function(object, error) {
    // The object was not retrieved successfully.
    // error is a Parse.Error with an error code and message.
  }
});





});


  },
  error: function(error) {
    alert("Error: " + error.code + " " + error.message);
  }
});
}



</script>



</body>
</html>
